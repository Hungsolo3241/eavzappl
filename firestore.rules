rules_version = '2';
 
 service cloud.firestore {
   match /databases/{database}/documents {
 
     // By default, no one can access anything.
     // Specific rules below will grant access.
     match /{document=**} {
       allow read, write: if false;
     }
 
     // --- User Profile Rules ---
     match /users/{userId} {
       // Any authenticated user can read any other user's profile.
       // This is necessary for swiping.
       allow get, list: if request.auth != null;

       // A user can only write to (update) their OWN profile.
       allow create: if request.auth.uid == userId;
       allow update: if request.auth.uid == userId;

       // --- Subcollection Rules ---
       // Users can only read and write their own private subcollections.
       match /likesSent/{docId} {
         allow read, write: if request.auth.uid == userId;
       }
       match /likesReceived/{likerId} {
         allow read: if request.auth.uid == userId;
         // The person who LIKED the profile can create/delete the 'like received' doc     
         allow write: if request.auth.uid == likerId;
       }
       match /userFavorites/{docId} {
         allow read, write: if request.auth.uid == userId;
       }
       match /profileViewLog/{viewerId} {
         allow read: if request.auth.uid == userId;
         // The person VIEWING the profile can create/update the log entry
         allow write: if request.auth.uid == viewerId;
       }

       // NEW RULE: Allow authenticated users to read their own notification settings      
       match /preferences/{document=**} {
         allow read, write: if request.auth != null && request.auth.uid == userId;
       }
     }

     // --- Matches Collection Rules ---
     match /matches/{matchId} {
       // **THE CRITICAL FIX IS HERE**
       // Any authenticated user can perform a LIST query on the collection.
       // This is REQUIRED for your '.where('users', arrayContains: ...)' query to work.   
       allow list: if request.auth != null;

       // A user can GET a specific match document if their UID is in the 'users' array.   
       allow get: if request.auth.uid in resource.data.users;

       // A user can CREATE a match document if their UID is in the 'users' array.
       allow create: if request.auth.uid in request.resource.data.users;

       // A user can DELETE a match if their UID is part of the document ID.
       allow delete: if request.auth.uid in matchId.split('_');
    }
  }
}